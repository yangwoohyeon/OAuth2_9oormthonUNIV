<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
</head>
<body>
<h2>ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>
<div>
    <label>Access Token: <input type="text" id="token" /></label><br>
    <label>ë³´ë‚´ëŠ” ì‚¬ëŒ ID: <input type="text" id="senderId" /></label><br>
    <label>ë°›ëŠ” ì‚¬ëŒ ID: <input type="text" id="receiverId" /></label><br>
    <label>ë©”ì‹œì§€ ë‚´ìš©: <input type="text" id="message" /></label><br>
    <button onclick="connectWebSocket()">WebSocket ì—°ê²°</button>
    <button onclick="sendJoin()">JOIN</button>
    <button onclick="sendMessage()">TALK</button>
    <button onclick="sendLeave()">LEAVE</button>
</div>

<h3>ì±„íŒ… ë¡œê·¸</h3>
<pre id="chatLog" style="background:#eee; padding:10px; height:300px; overflow-y:scroll;"></pre>

<script>
    let socket;
    let currentRoomId = null; // ğŸ”¥ ì—¬ê¸°ì— ì €ì¥ë¨

    // 1. ì„œë²„ì—ì„œ ì±„íŒ…ë°© IDë¥¼ ë¨¼ì € ë°›ì•„ì˜¤ëŠ” í•¨ìˆ˜
    async function getOrCreateChatRoomId() {
        const senderId = document.getElementById("senderId").value;
        const receiverId = document.getElementById("receiverId").value;

        const res = await fetch(`/api/chat/room?userA=${senderId}&userB=${receiverId}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${document.getElementById("token").value}`
            }
        });
        const roomId = await res.json(); // ì„œë²„ì—ì„œ roomId ë°˜í™˜ë°›ìŒ
        currentRoomId = roomId;
        log("ğŸ†” ì±„íŒ…ë°© ID: " + currentRoomId);
    }

    // 2. WebSocket ì—°ê²° ì „ì— ì±„íŒ…ë°© ID ë¨¼ì € ë°›ì•„ì˜¤ê¸°
    async function connectWebSocket() {
        const token = document.getElementById("token").value;

        // ğŸ”¥ ì±„íŒ…ë°© ID ë°›ì•„ì˜¤ê¸° ë¨¼ì €!
        await getOrCreateChatRoomId();

        const socketUrl = "ws://localhost:8080/ws/conn?token=" + encodeURIComponent(token);
        socket = new WebSocket(socketUrl);

        socket.onopen = () => log("âœ… WebSocket ì—°ê²°ë¨");
        socket.onmessage = (event) => log("ğŸ“© " + event.data);
        socket.onclose = () => log("âŒ ì—°ê²° ì¢…ë£Œë¨");
        socket.onerror = (e) => log("âš ï¸ ì—ëŸ¬ ë°œìƒ: " + e);
    }

    function sendJoin() {
        const msg = createMessage("JOIN");
        socket.send(JSON.stringify(msg));
    }

    function sendMessage() {
        const msg = createMessage("TALK");
        socket.send(JSON.stringify(msg));
    }

    function sendLeave() {
        const msg = createMessage("LEAVE");
        socket.send(JSON.stringify(msg));
    }

    function createMessage(type) {
        return {
            messageType: type,
            chatRoomId: currentRoomId, // âœ… ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ID ì‚¬ìš©
            senderId: document.getElementById("senderId").value,
            receiverId: document.getElementById("receiverId").value,
            message: document.getElementById("message").value
        };
    }

    function log(message) {
        const logArea = document.getElementById("chatLog");
        logArea.textContent += message + "\n";
        logArea.scrollTop = logArea.scrollHeight;
    }
</script>
</body>
</html>
